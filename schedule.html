<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Schedule Management | Lesotho Digital Innovation Summit</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <!-- FullCalendar CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css"
      rel="stylesheet"
    />
    <!-- Flatpickr for datetime input -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <!-- Custom CSS -->
    <style>
      :root {
        --primary-color: #0a2240;
        --secondary-color: #00aeef;
        --accent-color: #e31937;
        --light-color: #f8f9fa;
        --dark-color: #212529;
      }

      body {
        font-family: "Roboto", sans-serif;
        background-color: #f5f7fa;
      }

      .sidebar {
        min-height: 100vh;
        background-color: var(--primary-color);
        color: white;
        position: fixed;
        width: 250px;
        transition: all 0.3s;
        z-index: 1000;
      }

      .main-content {
        margin-left: 250px;
        transition: all 0.3s;
      }

      .sidebar-header {
        padding: 20px;
        background-color: rgba(0, 0, 0, 0.2);
      }

      .sidebar-menu {
        padding: 20px 0;
      }

      .menu-item {
        padding: 12px 20px;
        color: rgba(255, 255, 255, 0.8);
        display: block;
        text-decoration: none;
        border-left: 3px solid transparent;
        transition: all 0.3s;
      }

      .menu-item:hover,
      .menu-item.active {
        background-color: rgba(0, 0, 0, 0.2);
        color: white;
        border-left-color: var(--secondary-color);
      }

      .menu-item i {
        margin-right: 10px;
        width: 20px;
        text-align: center;
      }

      .navbar {
        background-color: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .card {
        border: none;
        border-radius: 8px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
      }

      .btn-primary {
        background-color: var(--secondary-color);
        border-color: var(--secondary-color);
      }

      .btn-primary:hover {
        background-color: #0095d9;
        border-color: #0095d9;
      }

      .btn-outline-primary {
        border-color: var(--secondary-color);
        color: var(--secondary-color);
      }

      .btn-outline-primary:hover {
        background-color: var(--secondary-color);
        color: white;
      }

      .badge-primary {
        background-color: var(--secondary-color);
      }

      .fc-event {
        cursor: pointer;
      }

      .session-type-keynote {
        background-color: #6610f2;
        border-color: #6610f2;
      }

      .session-type-workshop {
        background-color: #d63384;
        border-color: #d63384;
      }

      .session-type-panel {
        background-color: #fd7e14;
        border-color: #fd7e14;
      }

      .session-type-presentation {
        background-color: #20c997;
        border-color: #20c997;
      }

      .session-type-networking {
        background-color: #0dcaf0;
        border-color: #0dcaf0;
      }

      .modal-header {
        background-color: var(--primary-color);
        color: white;
      }

      @media (max-width: 992px) {
        .sidebar {
          margin-left: -250px;
        }

        .sidebar.active {
          margin-left: 0;
        }

        .main-content {
          margin-left: 0;
        }

        .main-content.active {
          margin-left: 250px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h4>SkyAlpha HD</h4>
      </div>
      <div class="sidebar-menu">
        <a href="dashboard.html" class="menu-item">
          <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
        <a href="live-sessions.html" class="menu-item">
          <i class="fas fa-video"></i> Live Sessions
        </a>
        <a href="videos.html" class="menu-item">
          <i class="fas fa-film"></i> Video Library
        </a>
        <a href="schedule.html" class="menu-item active">
          <i class="fas fa-calendar-alt"></i> Event Schedule
        </a>
        <a href="speakers.html" class="menu-item">
          <i class="fas fa-users"></i> Speakers
        </a>
        <a href="universities.html" class="menu-item">
          <i class="fas fa-university"></i> Universities
        </a>
        <a href="analytics.html" class="menu-item">
          <i class="fas fa-chart-line"></i> Analytics
        </a>
        <a href="users.html" class="menu-item">
          <i class="fas fa-user-cog"></i> User Management
        </a>
        <a href="settings.html" class="menu-item">
          <i class="fas fa-cog"></i> Settings
        </a>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="main-content">
      <!-- Top Navbar -->
      <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">
          <button class="btn btn-link" id="sidebarToggle">
            <i class="fas fa-bars"></i>
          </button>
          <div class="d-flex align-items-center ms-auto">
            <div class="dropdown me-3">
              <button
                class="btn btn-link dropdown-toggle"
                type="button"
                id="notificationsDropdown"
                data-bs-toggle="dropdown"
              >
                <i class="fas fa-bell"></i>
                <span class="badge bg-danger rounded-pill">3</span>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#">New session added</a></li>
                <li>
                  <a class="dropdown-item" href="#">2 new registrations</a>
                </li>
                <li>
                  <a class="dropdown-item" href="#">System update available</a>
                </li>
              </ul>
            </div>
            <div class="dropdown">
              <button
                class="btn btn-link dropdown-toggle"
                type="button"
                id="userDropdown"
                data-bs-toggle="dropdown"
              >
                <img
                  src="https://via.placeholder.com/40"
                  class="rounded-circle me-2"
                  alt="User"
                />
                <span>Admin User</span>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <a class="dropdown-item" href="#"
                    ><i class="fas fa-user me-2"></i> Profile</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="#"
                    ><i class="fas fa-cog me-2"></i> Settings</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="#"
                    ><i class="fas fa-sign-out-alt me-2"></i> Logout</a
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>
      </nav>

      <!-- Page Content -->
      <div class="container-fluid py-4">
        <div class="row mb-4">
          <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
              <h2 class="mb-0">Event Schedule Management</h2>
              <button
                class="btn btn-primary"
                data-bs-toggle="modal"
                data-bs-target="#addSessionModal"
              >
                <i class="fas fa-plus me-2"></i> Add Session
              </button>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <div id="calendar"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Session Modal -->
    <div
      class="modal fade"
      id="addSessionModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add New Session</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="sessionForm">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="sessionTitle" class="form-label"
                    >Session Title</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="sessionTitle"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label for="sessionType" class="form-label"
                    >Session Type</label
                  >
                  <select class="form-select" id="sessionType" required>
                    <option value="">Select type</option>
                    <option value="keynote">Keynote</option>
                    <option value="workshop">Workshop</option>
                    <option value="panel">Panel Discussion</option>
                    <option value="presentation">Presentation</option>
                    <option value="networking">Networking</option>
                  </select>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="startTime" class="form-label">Start Time</label>
                  <input
                    type="text"
                    class="form-control datetimepicker"
                    id="startTime"
                    required
                  />
                </div>
                <div class="col-md-6">
                  <label for="endTime" class="form-label">End Time</label>
                  <input
                    type="text"
                    class="form-control datetimepicker"
                    id="endTime"
                    required
                  />
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="sessionSpeaker" class="form-label">Speaker</label>
                  <select class="form-select" id="sessionSpeaker">
                    <option value="">Select speaker</option>
                    <!-- Will be populated from Firebase -->
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="sessionUniversity" class="form-label"
                    >University</label
                  >
                  <select class="form-select" id="sessionUniversity">
                    <option value="">Select university</option>
                    <!-- Will be populated from Firebase -->
                  </select>
                </div>
              </div>
              <div class="mb-3">
                <label for="sessionDescription" class="form-label"
                  >Description</label
                >
                <textarea
                  class="form-control"
                  id="sessionDescription"
                  rows="3"
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="sessionLocation" class="form-label">Location</label>
                <input type="text" class="form-control" id="sessionLocation" />
              </div>
              <div class="mb-3 form-check">
                <input
                  type="checkbox"
                  class="form-check-input"
                  id="isLiveStream"
                />
                <label class="form-check-label" for="isLiveStream"
                  >This session will be live streamed</label
                >
              </div>
              <div class="mb-3" id="streamDetails" style="display: none">
                <label for="streamLink" class="form-label">Stream Link</label>
                <input type="url" class="form-control" id="streamLink" />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="saveSession">
              Save Session
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- View/Edit Session Modal -->
    <div
      class="modal fade"
      id="sessionDetailsModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="sessionModalTitle">Session Details</h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" id="sessionModalBody">
            <!-- Content will be loaded dynamically -->
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary" id="editSessionBtn">
              Edit
            </button>
            <button type="button" class="btn btn-danger" id="deleteSessionBtn">
              Delete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- FullCalendar JS -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Firebase SDK v9 -->
    <script type="module">
      // Import the functions you need from the Firebase SDK
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
      import {
        getDatabase,
        ref,
        onValue,
        set,
        remove,
        push,
        serverTimestamp,
        get,
      } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDd6FDb2rARFw_9nFWL1qKQaXKZe3yoATU",
        authDomain: "dislesotho.firebaseapp.com",
        databaseURL: "https://dislesotho-default-rtdb.firebaseio.com",
        projectId: "dislesotho",
        storageBucket: "dislesotho.appspot.com",
        messagingSenderId: "261504066381",
        appId: "1:261504066381:web:c2d94a6ed2ade11bba0d04",
        measurementId: "G-27WXR9RBMR",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const database = getDatabase(app);

      // Initialize datetime picker
      $(".datetimepicker").flatpickr({
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        time_24hr: true,
      });

      // Toggle sidebar
      $("#sidebarToggle").click(function () {
        $("#sidebar").toggleClass("active");
        $("#main-content").toggleClass("active");
      });

      // Toggle stream details
      $("#isLiveStream").change(function () {
        if ($(this).is(":checked")) {
          $("#streamDetails").show();
        } else {
          $("#streamDetails").hide();
        }
      });

      // Initialize calendar
      const calendarEl = document.getElementById("calendar");
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        headerToolbar: {
          left: "prev,next today",
          center: "title",
          right: "dayGridMonth,timeGridWeek,timeGridDay",
        },
        events: [], // Will be populated from Firebase
        eventClick: function (info) {
          showSessionDetails(info.event);
        },
        eventClassNames: function (arg) {
          return ["session-type-" + arg.event.extendedProps.type];
        },
      });
      calendar.render();

      // Load data when page loads
      document.addEventListener("DOMContentLoaded", function () {
        loadSpeakers();
        loadUniversities();
        loadSessions();
      });

      // Save session
      $("#saveSession").click(function () {
        saveSession();
      });

      // Edit session
      $("#editSessionBtn").click(function () {
        editSession();
      });

      // Delete session
      $("#deleteSessionBtn").click(function () {
        deleteSession();
      });

      // Load speakers from Firebase
      function loadSpeakers() {
        const speakersRef = ref(database, "speakers");
        onValue(speakersRef, (snapshot) => {
          const speakers = snapshot.val();
          const dropdown = $("#sessionSpeaker");
          dropdown.empty();
          dropdown.append('<option value="">Select speaker</option>');

          if (speakers) {
            Object.keys(speakers).forEach((key) => {
              const speaker = speakers[key];
              dropdown.append(
                `<option value="${key}">${speaker.name} - ${speaker.university}</option>`
              );
            });
          }
        });
      }

      // Load universities from Firebase
      function loadUniversities() {
        const universitiesRef = ref(database, "universities");
        onValue(universitiesRef, (snapshot) => {
          const universities = snapshot.val();
          const dropdown = $("#sessionUniversity");
          dropdown.empty();
          dropdown.append('<option value="">Select university</option>');

          if (universities) {
            Object.keys(universities).forEach((key) => {
              const university = universities[key];
              dropdown.append(
                `<option value="${key}">${university.name}</option>`
              );
            });
          }
        });
      }

      // Load sessions from Firebase
      function loadSessions() {
        const sessionsRef = ref(database, "sessions");
        onValue(
          sessionsRef,
          (snapshot) => {
            const sessions = snapshot.val();
            calendar.removeAllEvents(); // Clear existing events

            if (sessions) {
              Object.keys(sessions).forEach((key) => {
                const session = sessions[key];

                // Convert date strings to Date objects for FullCalendar
                const startDate = session.startTime
                  ? new Date(session.startTime)
                  : new Date();
                const endDate = session.endTime
                  ? new Date(session.endTime)
                  : new Date();

                calendar.addEvent({
                  id: key,
                  title: session.title,
                  start: startDate,
                  end: endDate,
                  extendedProps: {
                    type: session.type || "",
                    speaker: session.speaker || "",
                    university: session.university || "",
                    description: session.description || "",
                    location: session.location || "",
                    isLiveStream: session.isLiveStream || false,
                    streamLink: session.streamLink || "",
                  },
                });
              });
            }
          },
          {
            onlyOnce: false, // Keep listening for changes
          }
        );
      }

      // Save session to Firebase
      async function saveSession() {
        const sessionId =
          $("#sessionDetailsModal").data("sessionId") ||
          push(ref(database, "sessions")).key;

        // Basic validation
        if (
          !$("#sessionTitle").val() ||
          !$("#sessionType").val() ||
          !$("#startTime").val() ||
          !$("#endTime").val()
        ) {
          alert("Please fill in all required fields");
          return;
        }

        const sessionData = {
          title: $("#sessionTitle").val(),
          type: $("#sessionType").val(),
          startTime: $("#startTime").val(),
          endTime: $("#endTime").val(),
          speaker: $("#sessionSpeaker").val(),
          university: $("#sessionUniversity").val(),
          description: $("#sessionDescription").val(),
          location: $("#sessionLocation").val(),
          isLiveStream: $("#isLiveStream").is(":checked"),
          streamLink: $("#isLiveStream").is(":checked")
            ? $("#streamLink").val()
            : "",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
        };

        try {
          // Save to Firebase
          await set(ref(database, "sessions/" + sessionId), sessionData);

          // Reset form and close modal
          $("#sessionForm")[0].reset();
          $("#addSessionModal").modal("hide");
          $("#sessionDetailsModal").removeData("sessionId");

          console.log("Session saved successfully:", sessionId);
        } catch (error) {
          console.error("Error saving session:", error);
          alert("Error saving session: " + error.message);
        }
      }

      // Show session details
      function showSessionDetails(event) {
        const session = {
          id: event.id,
          title: event.title,
          startTime: event.start,
          endTime: event.end,
          type: event.extendedProps.type,
          speaker: event.extendedProps.speaker,
          university: event.extendedProps.university,
          description: event.extendedProps.description,
          location: event.extendedProps.location,
          isLiveStream: event.extendedProps.isLiveStream,
          streamLink: event.extendedProps.streamLink,
        };

        // Store session ID for editing
        $("#sessionDetailsModal").data("sessionId", session.id);

        // Format date and time
        const startDate = new Date(session.startTime);
        const endDate = new Date(session.endTime);
        const dateOptions = {
          weekday: "long",
          year: "numeric",
          month: "long",
          day: "numeric",
        };
        const timeOptions = { hour: "2-digit", minute: "2-digit" };

        // Get speaker and university names
        let speakerName = "Not specified";
        let universityName = "Not specified";

        if (session.speaker) {
          get(ref(database, "speakers/" + session.speaker)).then((snapshot) => {
            const speaker = snapshot.val();
            if (speaker) {
              speakerName = speaker.name;
              universityName = speaker.university;
              $("#sessionModalSpeaker").text(speakerName);
              $("#sessionModalUniversity").text(universityName);
            }
          });
        }

        // Build modal content
        let content = `
                <div class="mb-3">
                    <h6 class="text-muted">Date & Time</h6>
                    <p>${startDate.toLocaleDateString("en-US", dateOptions)}</p>
                    <p>${startDate.toLocaleTimeString(
                      "en-US",
                      timeOptions
                    )} - ${endDate.toLocaleTimeString("en-US", timeOptions)}</p>
                </div>
                <div class="mb-3">
                    <h6 class="text-muted">Session Type</h6>
                    <p><span class="badge session-type-${session.type}">${
          session.type.charAt(0).toUpperCase() + session.type.slice(1)
        }</span></p>
                </div>
                <div class="mb-3">
                    <h6 class="text-muted">Speaker</h6>
                    <p id="sessionModalSpeaker">${speakerName}</p>
                </div>
                <div class="mb-3">
                    <h6 class="text-muted">University</h6>
                    <p id="sessionModalUniversity">${universityName}</p>
                </div>
            `;

        if (session.location) {
          content += `
                    <div class="mb-3">
                        <h6 class="text-muted">Location</h6>
                        <p>${session.location}</p>
                    </div>
                `;
        }

        if (session.isLiveStream && session.streamLink) {
          content += `
                    <div class="mb-3">
                        <h6 class="text-muted">Live Stream</h6>
                        <p><a href="${session.streamLink}" target="_blank">${session.streamLink}</a></p>
                    </div>
                `;
        }

        if (session.description) {
          content += `
                    <div class="mb-3">
                        <h6 class="text-muted">Description</h6>
                        <p>${session.description}</p>
                    </div>
                `;
        }

        // Set modal content and show
        $("#sessionModalTitle").text(session.title);
        $("#sessionModalBody").html(content);
        $("#sessionDetailsModal").modal("show");
      }

      // Edit session
      function editSession() {
        const sessionId = $("#sessionDetailsModal").data("sessionId");
        $("#sessionDetailsModal").modal("hide");

        // Get session data from Firebase
        get(ref(database, "sessions/" + sessionId)).then((snapshot) => {
          const session = snapshot.val();
          if (session) {
            // Populate form
            $("#sessionTitle").val(session.title);
            $("#sessionType").val(session.type);
            $("#startTime").val(session.startTime);
            $("#endTime").val(session.endTime);
            $("#sessionSpeaker").val(session.speaker);
            $("#sessionUniversity").val(session.university);
            $("#sessionDescription").val(session.description);
            $("#sessionLocation").val(session.location);

            if (session.isLiveStream) {
              $("#isLiveStream").prop("checked", true);
              $("#streamDetails").show();
              $("#streamLink").val(session.streamLink);
            } else {
              $("#isLiveStream").prop("checked", false);
              $("#streamDetails").hide();
            }

            // Store session ID for saving
            $("#sessionDetailsModal").data("sessionId", sessionId);

            // Show modal
            $("#addSessionModal").modal("show");
          }
        });
      }

      // Delete session
      function deleteSession() {
        if (confirm("Are you sure you want to delete this session?")) {
          const sessionId = $("#sessionDetailsModal").data("sessionId");
          remove(ref(database, "sessions/" + sessionId))
            .then(() => {
              $("#sessionDetailsModal").modal("hide");
            })
            .catch((error) => {
              alert("Error deleting session: " + error.message);
            });
        }
      }
    </script>
  </body>
</html>
